# خطوط أنابيب قابلة لإعادة الإنتاج

تعد نماذج الانتشار عشوائية بطبيعتها، مما يسمح لها بتوليد مخرجات مختلفة في كل مرة يتم تشغيلها فيها. ولكن هناك أوقات معينة تريد فيها توليد نفس الإخراج في كل مرة، مثل عند إجراء الاختبارات، وتكرار النتائج، وحتى [تحسين جودة الصورة](#deterministic-batch-generation). في حين أنه لا يمكنك توقع الحصول على نتائج متطابقة عبر المنصات، يمكنك توقع نتائج قابلة للتكرار عبر الإصدارات والمنصات ضمن نطاق تسامح معين (على الرغم من أن حتى هذا قد يختلف).

سيوضح هذا الدليل كيفية التحكم في العشوائية من أجل التوليد المحدد على وحدة المعالجة المركزية ووحدات معالجة الرسوميات.

> [!نصيحة]
> نوصي بشدة بقراءة بيان PyTorch [عن قابلية إعادة الإنتاج](https://pytorch.org/docs/stable/notes/randomness.html):
>
> "النتائج القابلة للتكرار تمامًا غير مضمونة عبر إصدارات PyTorch، أو الالتزامات الفردية، أو المنصات المختلفة. علاوة على ذلك، قد لا تكون النتائج قابلة للتكرار بين عمليات التنفيذ على وحدة المعالجة المركزية ووحدات معالجة الرسوميات، حتى عند استخدام البذور المحددة."

## التحكم في العشوائية

خلال الاستدلال، تعتمد خطوط الأنابيب اعتمادًا كبيرًا على عمليات أخذ العينات العشوائية التي تشمل إنشاء
تنسورات ضوضاء غاوسية لإزالة التشويش وإضافة ضوضاء إلى خطوة الجدولة.

الق نظرة على قيم التنسور في [`DDIMPipeline`] بعد خطوتين من الاستدلال.

تختلف قيمة الإخراج في كل مرة يتم فيها تشغيل الشفرة، وذلك لأن [`torch.randn`] يستخدم بذرة عشوائية مختلفة في كل مرة يتم فيها إنشاء تنسور الضوضاء.

ولكن إذا كنت بحاجة إلى توليد نفس الصورة بشكل موثوق، فإن ذلك يعتمد على ما إذا كنت تشغل خط الأنابيب على وحدة المعالجة المركزية أو وحدة معالجة الرسوميات.

> [!نصيحة]
> قد يبدو من غير البديهي تمرير كائنات `Generator` إلى خط الأنابيب بدلاً من قيمة العدد الصحيح التي تمثل البذرة. ومع ذلك، هذا هو التصميم الموصى به عند العمل مع النماذج الاحتمالية في PyTorch لأن `Generator` هو *حالة عشوائية* يمكن تمريرها إلى خطوط أنابيب متعددة في تسلسل. بمجرد استهلاك `Generator`، يتم تغيير *الحالة* في المكان، مما يعني أنه حتى إذا قمت بتمرير نفس `Generator` إلى خط أنابيب مختلف، فلن ينتج نفس النتيجة لأن الحالة قد تغيرت بالفعل.

<hfoptions id="hardware">

<hfoption id="CPU">

لإنشاء نتائج قابلة للتكرار على وحدة المعالجة المركزية، ستحتاج إلى استخدام PyTorch [Generator] وتعيين بذرة. الآن عند تشغيل الكود، فإنه يطبع دائمًا قيمة `1491.1711` لأن كائن `Generator` بالبذرة يتم تمريره إلى جميع الوظائف العشوائية في خط الأنابيب. يجب أن تحصل على نتيجة مماثلة، إن لم تكن متطابقة، على أي أجهزة وأي إصدار PyTorch الذي تستخدمه.

</hfoption>

<hfoption id="GPU">

إن كتابة خط أنابيب قابل للتكرار على وحدة معالجة الرسوميات أكثر تعقيدًا بعض الشيء، ولا تُضمن قابلية التكرار الكاملة عبر الأجهزة المختلفة لأن الضرب المصفوفي - والذي تتطلبه خطوط أنابيب الانتشار الكثير منه - أقل حتمية على وحدة معالجة الرسوميات من وحدة المعالجة المركزية. على سبيل المثال، إذا قمت بتشغيل نفس مثال التعليمات البرمجية من مثال وحدة المعالجة المركزية، فستحصل على نتيجة مختلفة على الرغم من أن البذرة متطابقة. ويرجع ذلك إلى أن وحدة معالجة الرسوميات تستخدم مولد رقم عشوائي مختلف عن وحدة المعالجة المركزية.

لتجنب هذه المشكلة، تحتوي Diffusers على وظيفة [`~utils.torch_utils.randn_tensor`] لإنشاء ضوضاء عشوائية على وحدة المعالجة المركزية، ثم نقل التنسور إلى وحدة معالجة الرسوميات إذا لزم الأمر. يتم استخدام وظيفة [`~utils.torch_utils.randn_tensor`] في كل مكان داخل خط الأنابيب. الآن يمكنك استدعاء [torch.manual_seed] الذي يقوم تلقائيًا بإنشاء `Generator` وحدة المعالجة المركزية التي يمكن تمريرها إلى خط الأنابيب حتى إذا كان قيد التشغيل على وحدة معالجة الرسوميات.

> [!نصيحة]
> إذا كانت قابلية التكرار مهمة لحالتك الاستخدام، فنحن نوصي دائمًا بتمرير `Generator` وحدة المعالجة المركزية. غالبًا ما يكون فقدان الأداء ضئيلًا، وستولد قيمًا أكثر تشابها مما لو تم تشغيل خط الأنابيب على وحدة معالجة الرسوميات.

أخيرًا، غالبًا ما تكون خطوط الأنابيب الأكثر تعقيدًا مثل [`UnCLIPPipeline`] عرضة للغاية
خطأ انتشار الدقة. ستحتاج إلى استخدام
أجهزة وبرامج PyTorch متطابقة تمامًا من أجل قابلية التكرار الكاملة.

</hfoption>

</hfoptions>

## الخوارزميات المحددة

يمكنك أيضًا تكوين PyTorch لاستخدام خوارزميات محددة لإنشاء خط أنابيب قابل للتكرار. الجانب السلبي هو أن الخوارزميات المحددة قد تكون أبطأ من الخوارزميات غير المحددة وقد تلاحظ انخفاضًا في الأداء.

يحدث السلوك غير المحدد عندما يتم إطلاق العمليات في أكثر من تدفق CUDA واحد. لتجنب ذلك، قم بتعيين متغير البيئة [CUBLAS_WORKSPACE_CONFIG] إلى `:16:8` لاستخدام حجم مخزن مؤقت واحد فقط أثناء وقت التشغيل.

عادةً ما يقوم PyTorch باختبار خوارزميات متعددة لاختيار أسرعها، ولكن إذا كنت تريد قابلية التكرار، فيجب عليك تعطيل هذه الميزة لأن الاختبار قد يختار خوارزميات مختلفة في كل مرة. قم بتعيين خيار [enable_full_determinism] في Diffusers لتمكين الخوارزميات المحددة.

الآن عند تشغيل خط الأنابيب نفسه مرتين، ستحصل على نتائج متطابقة.

```py
pipe = StableDiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5", use_safetensors=True).to("cuda")
pipe.scheduler = DDIMScheduler.from_config(pipe.scheduler.config)

prompt = "A bear is playing a guitar on Times Square"

g.manual_seed(0)
result1 = pipe(prompt=prompt, num_inference_steps=50, generator=g, output_type="latent").images

g.manual_seed(0)
result2 = pipe(prompt=prompt, num_inference_steps=50, generator=g, output_type="latent").images

print("L_inf dist =", abs(result1 - result2).max())
"L_inf dist = tensor(0., device='cuda:0')"
```
## التوليد الدفعي المحدد

تتمثل إحدى التطبيقات العملية لإنشاء خطوط أنابيب قابلة للاستنساخ في "التوليد الدفعي المحدد". حيث تقوم بتوليد دفعة من الصور واختيار صورة واحدة لتحسينها باستخدام موجه أكثر تفصيلاً. وتكمن الفكرة الرئيسية في تمرير قائمة من "المولدات" إلى خط الأنابيب وربط كل مولد ببذرة بحيث يمكن إعادة استخدامها.

دعونا نستخدم نقطة تفتيش [runwayml/stable-diffusion-v1-5](https://huggingface.co/runwayml/stable-diffusion-v1-5) ولتوليد دفعة من الصور.

```py
... # الكود البرمجي
```

قم بتعريف أربعة مولدات `Generator` مختلفة وقم بتعيين بذرة لكل مولد (`0` إلى `3`). ثم قم بتوليد دفعة من الصور واختر واحدة منها لتكرارها.

> [!تحذير]
> استخدم قائمة الفهم التي تقوم بالحلق على حجم الدفعة المحدد في `range()` لإنشاء كائن `Generator` فريد لكل صورة في الدفعة. إذا قمت بضرب `Generator` بحجم دفعة الأعداد الصحيحة، فلن يتم إنشاء سوى كائن `Generator` واحد يتم استخدامه بشكل تسلسلي لكل صورة في الدفعة.
>
> ```py
> [torch.Generator().manual_seed(seed)] * 4
> ```

```python
... # الكود البرمجي
```

دعونا نحسن الصورة الأولى (يمكنك اختيار أي صورة تريدها) والتي تتوافق مع المولد ذو البذرة `0`. أضف بعض النص الإضافي إلى موجهك وتأكد من إعادة استخدام نفس المولد مع البذرة `0`. يجب أن تشبه جميع الصور المولدة الصورة الأولى.

```python
... # الكود البرمجي
```

هل كانت هذه الترجمة مفيدة؟ يمكنني تقديم المساعدة إذا كانت هناك أي تعليمات أو نص إضافي تريد ترجمته.