# ุงูุชุฏุฑูุจ ุงููุนุงู ุนูู ูุนุงูุฌุงุช GPU ูุชุนุฏุฏุฉ

ุฅุฐุง ูุงู ุชุฏุฑูุจ ูููุฐุฌ ุนูู ูุนุงูุฌ GPU ูุงุญุฏ ุจุทูุฆูุง ุฌุฏูุง ุฃู ุฅุฐุง ูู ุชุชุณุน ุฐุงูุฑุฉ ูุนุงูุฌ GPU ุงููุงุญุฏ ูุฃูุฒุงู ุงููููุฐุฌุ ููุฏ ูููู ุงูุงูุชูุงู ุฅูู ุฅุนุฏุงุฏ ูุชุนุฏุฏ ูุนุงูุฌุงุช GPU ุฎูุงุฑูุง ูุงุจููุง ููุชุทุจูู. ูุจู ุฅุฌุฑุงุก ูุฐุง ุงูุงูุชูุงูุ ุงุณุชูุดู ุจุดูู ุดุงูู ุฌููุน ุงูุงุณุชุฑุงุชูุฌูุงุช ุงููุดูููุฉ ูู "ุฃุณุงููุจ ูุฃุฏูุงุช ุงูุชุฏุฑูุจ ุงููุนุงู ุนูู ูุนุงูุฌ GPU ูุงุญุฏ" ุญูุซ ุฃููุง ุชูุทุจู ุนุงููููุง ุนูู ุชุฏุฑูุจ ุงูููุงุฐุฌ ุนูู ุฃู ุนุฏุฏ ูู ูุนุงูุฌุงุช GPU. ุจูุฌุฑุฏ ุงุณุชุฎุฏุงูู ูุชูู ุงูุงุณุชุฑุงุชูุฌูุงุช ูุงูุชุดุงู ุฃููุง ุบูุฑ ูุงููุฉ ูุญุงูุชู ุนูู ูุนุงูุฌ GPU ูุงุญุฏุ ููุฑ ูู ุงูุงูุชูุงู ุฅูู ูุนุงูุฌุงุช GPU ูุชุนุฏุฏุฉ.

ูุชุทูุจ ุงูุงูุชูุงู ูู ูุนุงูุฌ GPU ูุงุญุฏ ุฅูู ูุนุงูุฌุงุช GPU ูุชุนุฏุฏุฉ ุชูุฏูู ุจุนุถ ุฃุดูุงู ุงูุชูุงุฒูุ ุญูุซ ูุฌุจ ุชูุฒูุน ุนุจุก ุงูุนูู ุนุจุฑ ุงูููุงุฑุฏ. ูููู ุงุณุชุฎุฏุงู ุชูููุงุช ูุชุนุฏุฏุฉ ูุชุญููู ุงูุชูุงุฒูุ ูุซู ุงูุชูุงุฒู ูู ุงูุจูุงูุงุชุ ูุงูุชูุงุฒู ูู ุงููุตูููุงุชุ ูุงูุชูุงุฒู ูู ุงูุฃูุงุจูุจ. ูู ุงูููู ููุงุญุธุฉ ุฃูู ูุง ููุฌุฏ ุญู ูุงุญุฏ ููุงุณุจ ุงูุฌููุนุ ูุฃู ุงูุฅุนุฏุงุฏุงุช ุงููุซุงููุฉ ุชุนุชูุฏ ุนูู ุชูููู ุงูุฃุฌูุฒุฉ ุงููุญุฏุฏ ุงูุฐู ุชุณุชุฎุฏูู.

ููุฏู ูุฐุง ุงูุฏููู ูุธุฑุฉ ูุชุนููุฉ ุนูู ุฃููุงุน ูุฑุฏูุฉ ูู ุงูุชูุงุฒูุ ุจุงูุฅุถุงูุฉ ุฅูู ุชูุฌููุงุช ุญูู ุทุฑู ุงูุฌูุน ุจูู ุงูุชูููุงุช ูุงุฎุชูุงุฑ ุงูููุฌ ุงูููุงุณุจ. ููุญุตูู ุนูู ุฏุฑูุณ ุฎุทูุฉ ุจุฎุทูุฉ ุญูู ุงูุชุฏุฑูุจ ุงูููุฒุนุ ูุฑุฌู ุงูุฑุฌูุน ุฅูู ูุซุงุฆู ๐ค Accelerate.

ูุจู ุงูุบูุต ุจุดูู ุฃุนูู ูู ุชูุงุตูู ูู ุชูููุฉุ ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ุนูููุฉ ุงุชุฎุงุฐ ุงููุฑุงุฑ ุนูุฏ ุชุฏุฑูุจ ููุงุฐุฌ ูุจูุฑุฉ ุนูู ุจููุฉ ุชุญุชูุฉ ูุจูุฑุฉ.

## ุงุณุชุฑุงุชูุฌูุฉ ูุงุจููุฉ ุงูุชูุณุน

ุงุจุฏุฃ ุจุชูุฏูุฑ ููุฏุงุฑ ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ุงูุธุงูุฑู (vRAM) ุงููุทููุจุฉ ูุชุฏุฑูุจ ูููุฐุฌู. ุจุงููุณุจุฉ ููููุงุฐุฌ ุงููุณุชุถุงูุฉ ุนูู ๐ค Hubุ ุงุณุชุฎุฏู "ุขูุฉ ุญุงุณุจุฉ ุฐุงูุฑุฉ ุงููููุฐุฌ" ุงูุฎุงุตุฉ ุจูุงุ ูุงูุชู ุชููุฑ ูู ุญุณุงุจุงุช ุฏูููุฉ ุถูู ูุงูุด ุจูุณุจุฉ 5%.

**ุงุณุชุฑุงุชูุฌูุฉ ุงูููุงุฒุงุฉ ูุนูุฏุฉ ูุงุญุฏุฉ / ุฅุนุฏุงุฏ ูุชุนุฏุฏ ูุนุงูุฌุงุช GPU**

ุนูุฏ ุชุฏุฑูุจ ูููุฐุฌ ุนูู ุนูุฏุฉ ูุงุญุฏุฉ ูุน ูุนุงูุฌุงุช GPU ูุชุนุฏุฏุฉุ ูููู ูุฎูุงุฑ ุงุณุชุฑุงุชูุฌูุฉ ุงูููุงุฒุงุฉ ุฃู ูุคุซุฑ ุจุดูู ูุจูุฑ ุนูู ุงูุฃุฏุงุก. ูููุง ููู ุชูุตูู ูุฎูุงุฑุงุชู:

**ุงูุญุงูุฉ 1: ููุงุณุจ ูููุฐุฌู ูุนุงูุฌ GPU ูุงุญุฏ**

ุฅุฐุง ูุงู ูููุฐุฌู ููุงุณุจ ูุนุงูุฌ GPU ูุงุญุฏ ุจุดูู ูุฑูุญุ ูููุงู ุฎูุงุฑุงู ุฑุฆูุณูุงู:

1. DDP - Distributed DataParallel
2. ZeRO - ุงุนุชูุงุฏูุง ุนูู ุงููุถุน ูุงูุชูููู ุงููุณุชุฎุฏูุ ูุฏ ุชููู ูุฐู ุงูุทุฑููุฉ ุฃุณุฑุน ุฃู ูุงุ ููุน ุฐููุ ููู ุงูุฌุฏูุฑ ุชุฌุฑุจุชูุง.

**ุงูุญุงูุฉ 2: ูุง ููุงุณุจ ูููุฐุฌู ูุนุงูุฌ GPU ูุงุญุฏ**

ุฅุฐุง ูุงู ูููุฐุฌู ูุจูุฑูุง ุฌุฏูุง ุจุงููุณุจุฉ ููุนุงูุฌ GPU ูุงุญุฏุ ูููุงู ุนุฏุฉ ุจุฏุงุฆู ูุฌุจ ูุฑุงุนุงุชูุง:

1. PipelineParallel (PP)
2. ZeRO
3. TensorParallel (TP)

ูุน ูุฌูุฏ ุงุชุตุงู ุณุฑูุน ุจูู ุงูุนูุฏ (ูุซู NVLINK ุฃู NVSwitch)ุ ูุฌุจ ุฃู ุชุคุฏู ุฌููุน ุงูุงุณุชุฑุงุชูุฌูุงุช ุงูุซูุงุซ (PP ูZeRO ูTP) ุฅูู ุฃุฏุงุก ููุงุซู. ููุน ุฐููุ ุจุฏูู ูุฐู ุงูููุฒุงุชุ ุณูููู PP ุฃุณุฑุน ูู TP ุฃู ZeRO. ูุฏ ูุญุฏุซ ุฃูุถูุง ุงุฎุชูุงู ูู ุฏุฑุฌุฉ TP. ูู ุงูุฃูุถู ุชุฌุฑุจุฉ ุฅุนุฏุงุฏู ุงููุญุฏุฏ ูุชุญุฏูุฏ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุฃูุณุจ.

ูุชู ุงุณุชุฎุฏุงู TP ุฏุงุฆููุง ุชูุฑูุจูุง ุฏุงุฎู ุนูุฏุฉ ูุงุญุฏุฉ. ููุฐุง ูุนูู ุฃู ุญุฌู TP <= ูุนุงูุฌุงุช GPU ููู ุนูุฏุฉ.

**ุงูุญุงูุฉ 3: ูุง ุชูุงุณุจ ุงูุทุจูุฉ ุงูุฃูุจุฑ ูู ูููุฐุฌู ูุนุงูุฌ GPU ูุงุญุฏ**

1. ุฅุฐุง ููุช ูุง ุชุณุชุฎุฏู ZeROุ ููุฌุจ ุนููู ุงุณุชุฎุฏุงู TensorParallel (TP)ุ ูุฃู PipelineParallel (PP) ูุญุฏู ูู ูููู ูุงูููุง ูุงุณุชูุนุงุจ ุงูุทุจูุฉ ุงููุจูุฑุฉ.
2. ุฅุฐุง ููุช ุชุณุชุฎุฏู ZeROุ ูุงุนุชูุฏ ุฃูุถูุง ุงูุชูููุงุช ูู "ุฃุณุงููุจ ูุฃุฏูุงุช ุงูุชุฏุฑูุจ ุงููุนุงู ุนูู ูุนุงูุฌ GPU ูุงุญุฏ".

**ุงุณุชุฑุงุชูุฌูุฉ ุงูููุงุฒุงุฉ ูุนูุฏ ูุชุนุฏุฏุฉ / ุฅุนุฏุงุฏ ูุชุนุฏุฏ ูุนุงูุฌุงุช GPU**

* ุนูุฏ ูุฌูุฏ ุงุชุตุงู ุณุฑูุน ุจูู ุงูุนูุฏ (ูุซู NVLINK ุฃู NVSwitch)ุ ููุฑ ูู ุงุณุชุฎุฏุงู ุฃุญุฏ ุงูุฎูุงุฑูู ุงูุชุงูููู:

1. ZeRO - ูุฃูู ูุชุทูุจ ุฅุฌุฑุงุก ุชุนุฏููุงุช ุทูููุฉ ุนูู ุงููููุฐุฌ
2. ูุฒูุฌ ูู PipelineParallel(PP) ูุน TensorParallel(TP) ูDataParallel(DP) - ุณูุคุฏู ูุฐุง ุงูููุฌ ุฅูู ุชูููู ุงูุงุชุตุงูุงุชุ ููููู ูุชุทูุจ ุฅุฌุฑุงุก ุชุบููุฑุงุช ูุจูุฑุฉ ุนูู ุงููููุฐุฌ

* ุนูุฏ ูุฌูุฏ ุงุชุตุงู ุจุทูุก ุจูู ุงูุนูุฏ ููุง ุชุฒุงู ุฐุงูุฑุฉ ูุนุงูุฌ GPU ููุฎูุถุฉ:

1. ุงุณุชุฎุฏู ูุฒูุฌูุง ูู DataParallel(DP) ูุน PipelineParallel(PP) ูTensorParallel(TP) ูZeRO.

ูู ุงูุฃูุณุงู ุงูุชุงููุฉ ูู ูุฐุง ุงูุฏูููุ ุณูุบูุต ุจุดูู ุฃุนูู ูู ููููุฉ ุนูู ุฃุณุงููุจ ุงูุชูุงุฒู ุงููุฎุชููุฉ ูุฐู.

## ุงูุชูุงุฒู ูู ุงูุจูุงูุงุช

ุญุชู ูุน ูุฌูุฏ ูุนุงูุฌู GPU ููุทุ ููููู ุงูุงุณุชูุงุฏุฉ ุจุณูููุฉ ูู ูุฏุฑุงุช ุงูุชุฏุฑูุจ ุงููุนุฌูุฉ ุงูุชู ุชููุฑูุง ุงูููุฒุงุช ุงููุฏูุฌุฉ ูู PyTorchุ ูุซู `DataParallel` (DP) ู`DistributedDataParallel` (DDP). ูุงุญุธ ุฃู ูุซุงุฆู PyTorch ุชูุตู ุจุชูุถูู `DistributedDataParallel` (DDP) ุนูู `DataParallel` (DP) ููุชุฏุฑูุจ ุนูู ูุนุงูุฌุงุช GPU ุงููุชุนุฏุฏุฉ ูุฃูู ูุนูู ูุน ุฌููุน ุงูููุงุฐุฌ.

ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ููููุฉ ุนูู ูุงุชูู ุงูุทุฑููุชูู ููุง ุงูุฐู ูููุฒููุง.

### DataParallel ููุงุจู DistributedDataParallel

ูููู ุงูุงุฎุชูุงูุงุช ุงูุฑุฆูุณูุฉ ูู ุนุจุก ุงูุงุชุตุงู ุจูู ูุนุงูุฌุงุช GPU ุจูู ุงูุทุฑููุชููุ ุฏุนููุง ูุฑุงุฌุน ุงูุนูููุงุช ููู ุฏูุนุฉ:

[DDP]:

- ูู ููุช ุงูุจุฏุกุ ุชููู ุงูุนูููุฉ ุงูุฑุฆูุณูุฉ ุจูุณุฎ ุงููููุฐุฌ ูุฑุฉ ูุงุญุฏุฉ ูู ูุนุงูุฌ GPU 0 ุฅูู ุจููุฉ ูุนุงูุฌุงุช GPU.
- ุจุนุฏ ุฐููุ ููู ุฏูุนุฉ:
1. ูุณุชููู ูู ูุนุงูุฌ GPU ูุจุงุดุฑุฉ ูุตุบุฑุฉ ุงูุฏูุนุฉ ุงูุฎุงุตุฉ ุจู ูู ุงูุจูุงูุงุช.
2. ุฃุซูุงุก `backward`ุ ุจูุฌุฑุฏ ุฃู ุชุตุจุญ ุงูุชุฏุฑุฌุงุช ุงููุญููุฉ ุฌุงูุฒุฉุ ูุชู ุญุณุงุจ ูุชูุณุทูุง ุนุจุฑ ุฌููุน ุงูุนูููุงุช.

[DP]:

ููู ุฏูุนุฉ:

1. ููุฑุฃ ูุนุงูุฌ GPU 0 ุฏูุนุฉ ุงูุจูุงูุงุช ุซู ูุฑุณู ูุตุบุฑุฉ ุฏูุนุฉ ุฅูู ูู ูุนุงูุฌ GPU.
2. ูุชู ูุณุฎ ุงููููุฐุฌ ุงููุญุฏุซ ูู ูุนุงูุฌ GPU 0 ุฅูู ูู ูุนุงูุฌ GPU.
3. ูุชู ุชูููุฐ `forward`ุ ููุชู ุฅุฑุณุงู ุงูุฅุฎุฑุงุฌ ูู ูู ูุนุงูุฌ GPU ุฅูู ูุนุงูุฌ GPU 0 ูุญุณุงุจ ุงูุฎุณุงุฑุฉ.
4. ูุชู ุชูุฒูุน ุงูุฎุณุงุฑุฉ ูู ูุนุงูุฌ GPU 0 ุฅูู ุฌููุน ูุนุงูุฌุงุช GPUุ ููุชู ุชุดุบูู `backward`.
5. ูุชู ุฅุฑุณุงู ุงูุชุฏุฑุฌุงุช ูู ูู ูุนุงูุฌ GPU ุฅูู ูุนุงูุฌ GPU 0 ููุชู ุญุณุงุจ ูุชูุณุทูุง.

ุชุดูู ุงูุงุฎุชูุงูุงุช ุงูุฑุฆูุณูุฉ ูุง ููู:

1. ูููู DDP ุจุชูููุฐ ุนูููุฉ ุงุชุตุงู ูุงุญุฏุฉ ููุท ููู ุฏูุนุฉ - ุฅุฑุณุงู ุงูุชุฏุฑุฌุงุชุ ูู ุญูู ุฃู DP ูููู ุจุฎูุณุฉ ุชุจุงุฏูุงุช ุจูุงูุงุช ูุฎุชููุฉ ููู ุฏูุนุฉ. ูููู DDP ุจูุณุฎ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู `torch.distributed`ุ ุจูููุง ูููู DP ุจูุณุฎ ุงูุจูุงูุงุช ุฏุงุฎู ุงูุนูููุฉ ุนุจุฑ ุฎููุท Python (ูุงูุชู ุชูุฏู ูููุฏูุง ูุฑุชุจุทุฉ ุจู GIL). ูุชูุฌุฉ ูุฐููุ ูููู `DistributedDataParallel` (DDP) ุฃุณุฑุน ุจุดูู ุนุงู ูู `DataParallel` (DP) ูุง ูู ููู ูุฏูู ุงุชุตุงู ุจุทูุก ุจูู ุจุทุงูุงุช ูุนุงูุฌุงุช GPU.

2. ูู DPุ ูููู ูุนุงูุฌ GPU 0 ุจูุฒูุฏ ูู ุงูุนูู ููุงุฑูุฉ ุจูุนุงูุฌุงุช GPU ุงูุฃุฎุฑูุ ููุง ูุคุฏู ุฅูู ููุต ุงุณุชุฎุฏุงู ูุนุงูุฌ GPU.

3. ูุฏุนู DDP ุงูุชุฏุฑูุจ ุงูููุฒุน ุนุจุฑ ุฃุฌูุฒุฉ ูุชุนุฏุฏุฉุ ูู ุญูู ุฃู DP ูุง ูุฏุนู ุฐูู.

ูุฐู ููุณุช ูุงุฆูุฉ ุดุงููุฉ ุจุงูุงุฎุชูุงูุงุช ุจูู DP ูDDPุ ูููู ุงูุฏูุงุฆู ุงูุฃุฎุฑู ุชุฎุฑุฌ ุนู ูุทุงู ูุฐุง ุงูุฏููู. ููููู ุงูุญุตูู ุนูู ููู ุฃุนูู ููุฐู ุงูุทุฑู ูู ุฎูุงู ูุฑุงุกุฉ ูุฐู ุงูููุงูุฉ.

ุฏุนููุง ููุถุญ ุงูุงุฎุชูุงูุงุช ุจูู DP ูDDP ูู ุฎูุงู ุชุฌุฑุจุฉ. ุณูููู ุจุงุฎุชุจุงุฑ ุฃุฏุงุก DP ูDDP ูุน ุฅุถุงูุฉ ุณูุงู ูุฌูุฏ NVLink:

* ุงูุฃุฌูุฒุฉ: 2x TITAN RTX 24GB ููู ูููุง + NVlink ูุน 2 NVLinks (`NV2` ูู `nvidia-smi topo -m`).
* ุงูุจุฑูุฌูุงุช: `pytorch-1.8-to-be` + `cuda-11.0` / `transformers==4.3.0.dev0`.

ูุฅููุงู ููุฒุฉ NVLink ูู ุฃุญุฏ ุงูุงุฎุชุจุงุฑุงุชุ ูุณุชุฎุฏู `NCCL_P2P_DISABLE=1`.

ูููุง ููู ููุฏ ุงูุงุฎุชุจุงุฑ ูุฅุฎุฑุงุฌุงุชู:

**DP**

```bash
rm -r /tmp/test-clm; CUDA_VISIBLE_DEVICES=0,1 \
python examples/pytorch/language-modeling/run_clm.py \
--model_name_or_path openai-community/gpt2 --dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 \
--do_train --output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 110.5948, 'train_samples_per_second': 1.808, 'epoch': 0.69}
```

**DDP ูุน NVlink**

```bash
rm -r /tmp/test-clm; CUDA_VISIBLE_DEVICES=0,1 \
torchrun --nproc_per_node 2 examples/pytorch/language-modeling/run_clm.py \
--model_name_or_path openai-community/gpt2 --dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 \
--do_train --output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 101.9003, 'train_samples_per_second': 1.963, 'epoch': 0.69}
```

**DDP ุจุฏูู NVlink**

```bash
rm -r /tmp/test-clm; NCCL_P2P_DISABLE=1 CUDA_VISIBLE_DEVICES=0,1 \
torchrun --nproc_per_node 2 examples/pytorch/language-modeling/run_clm.py \
--model_name_or_path openai-community/gpt2 --dataset_name wikitext --dataset_config_name wikitext-2-raw-v1 \
--do_train --output_dir /tmp/test-clm --per_device_train_batch_size 4 --max_steps 200

{'train_runtime': 131.4367, 'train_samples_per_second': 1.522, 'epoch': 0.69}
```

ูููุง ููู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ููุณูุง ูุฌูุนุฉ ูู ุฌุฏูู ููุชุณููู:

| ุงูููุน | NVlink | ุงูููุช |
| :----- | -----  | ---: |
| 2:DP | Y | 110 ุซุงููุฉ |
| 2:DDP | Y | 101 ุซุงููุฉ |
| 2:DDP | N | 131 ุซุงููุฉ |

ููุง ุชุฑููุ ูู ูุฐู ุงูุญุงูุฉุ ูุงู DP ุฃุจุทุฃ ุจูุณุจุฉ 10% ุชูุฑูุจูุง ูู DDP ูุน NVlinkุ ููููู ุฃุณุฑุน ุจูุณุจุฉ 15% ูู DDP ุจุฏูู NVlink. ูุนุชูุฏ ุงูุงุฎุชูุงู ุงูุญูููู ุนูู ููุฏุงุฑ ุงูุจูุงูุงุช ุงูุชู ูุญุชุงุฌ ูู ูุนุงูุฌ GPU ุฅูู ูุฒุงููุชูุง ูุน ุงูุขุฎุฑูู - ููููุง ุฒุงุฏุช ุงูุจูุงูุงุช ุงูุชู ูุฌุจ ูุฒุงููุชูุงุ ูููุง ุฃุฏู ุงูุฑุงุจุท ุงูุจุทูุก ุฅูู ุฅุนุงูุฉ ููุช ุงูุชุดุบูู ุงูุฅุฌูุงูู.
## ููุงุฒุงุฉ ุจูุงูุงุช ZeRO

ูุชู ุชูุถูุญ ููุงุฒุงุฉ ุงูุจูุงูุงุช ุงููุฏุนููุฉ ูู ZeRO (ZeRO-DP) ูู ุงููุฎุทุท ุงูุชุงูู ูู ูุฐู [ุงูุชุฏูููุฉ](https://www.microsoft.com/en-us/research/blog/zero-deepspeed-new-system-optimizations-enable-training-models-with-over-100-billion-parameters/).

ูู ุญูู ูุฏ ูุจุฏู ุงูุฃูุฑ ูุนูุฏูุงุ ุฅูุง ุฃูู ููููู ูุดุงุจู ุฌุฏูุง ูู `DataParallel` (DP). ุงููุฑู ูู ุฃูู ุจุฏูุงู ูู ุงุณุชูุณุงุฎ ูุนููุงุช ุงููููุฐุฌ ุงููุงููุฉุ ูุงูุชุฏุฑุฌุงุชุ ูุญุงูุงุช ุงููุญุณูุ ูููู ูู ูุนุงูุฌ ุฑุณููุงุช GPU ุจุชุฎุฒูู ุดุฑูุญุฉ ููุท ููู. ุจุนุฏ ุฐููุ ูู ููุช ุงูุชุดุบูู ุนูุฏูุง ุชููู ูุนููุงุช ุงูุทุจูุฉ ุงููุงููุฉ ูุทููุจุฉ ููุท ููุทุจูุฉ ุงููุนุทุงุฉุ ุชุชู ูุฒุงููุฉ ุฌููุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช GPUs ูููุญ ุจุนุถูุง ุงูุจุนุถ ุงูุฃุฌุฒุงุก ุงูุชู ุชูุชูุฏูุง.

ูุชูุถูุญ ูุฐู ุงูููุฑุฉุ ุฏุนูุง ูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ ูููุฐุฌูุง ุจุณูุทูุง ูุชููู ูู 3 ุทุจูุงุช (La ูLb ูLc)ุ ุญูุซ ุชุญุชูู ูู ุทุจูุฉ ุนูู 3 ูุนููุงุช. ุนูู ุณุจูู ุงููุซุงูุ ุชุญุชูู ุงูุทุจูุฉ La ุนูู ุงูุฃูุฒุงู a0 ูa1 ูa2:

```
La | Lb | Lc
---|----|---
a0 | b0 | c0
a1 | b1 | c1
a2 | b2 | c2
```

ุฅุฐุง ูุงู ูุฏููุง 3 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช GPUุ ูุฅู ZeRO-DP ููุณู ุงููููุฐุฌ ุฅูู 3 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช GPU ููุง ููู:

```
GPU0:
La | Lb | Lc
---|----|---
a0 | b0 | c0

GPU1:
La | Lb | Lc
---|----|---
a1 | b1 | c1

GPU2:
La | Lb | Lc
---|----|---
a2 | b2 | c2
```

ูุจุทุฑููุฉ ูุงุ ูุฐุง ูู ููุณ ุงูุชูุทูุน ุงูุฃููู ููุง ูู ุงูุญุงู ูู ููุงุฒุงุฉ ุงูุชูุณูุฑุ ุนูู ุนูุณ ุงูุชูุทูุน ุงูุฑุฃุณูุ ุญูุซ ูุชู ูุถุน ูุฌููุนุงุช ุงูุทุจูุงุช ุงููุงููุฉ ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช GPU ูุฎุชููุฉ. ุงูุขู ุฏุนูุง ูุฑู ููู ูุนูู ูุฐุง:

ุณุชุญุตู ูู ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPUs ูุฐู ุนูู ุฏูุนุฉ ูุตุบุฑุฉ ุงููุนุชุงุฏุฉ ููุง ูู ุงูุญุงู ูู DP:

```
x0 => GPU0
x1 => GPU1
x2 => GPU2
```

ูุชู ุชูุฑูุฑ ุงููุฏุฎูุงุช ุฏูู ุชุนุฏููุงุช ููุง ูู ูุงูุช ุณุชุชู ูุนุงูุฌุชูุง ุจูุงุณุทุฉ ุงููููุฐุฌ ุงูุฃุตูู.

ุฃููุงูุ ุชุตู ุงููุฏุฎูุงุช ุฅูู ุงูุทุจูุฉ "La". ูุงุฐุง ูุญุฏุซ ูู ูุฐู ุงููุฑุญูุฉุ

ุนูู GPU0: ุชุชุทูุจ ุงูุฏูุนุฉ ุงููุตุบุฑุฉ x0 ูุนููุงุช a0 ูa1 ูa2 ููููุงู ุจูุณุงุฑูุง ุงูุฃูุงูู ุนุจุฑ ุงูุทุจูุฉุ ูููู GPU0 ูุญุชูู ุนูู a0 ููุท. ุณูู ูุญุตู ุนูู a1 ูู GPU1 ูa2 ูู GPU2ุ ูุฌูุน ุฌููุน ูุทุน ุงููููุฐุฌ ูุนุง.

ุจุงูุชูุงุฒูุ ุชุญุตู GPU1 ุนูู ุฏูุนุฉ ูุตุบุฑุฉ ุฃุฎุฑู - x1. ุชุญุชูู GPU1 ุนูู ุงููุนููุฉ a1ุ ูููููุง ุชุญุชุงุฌ ุฅูู a0 ูa2ุ ูุฐุง ููู ุชุญุตู ุนูููุง ูู GPU0 ูGPU2.

ูุญุฏุซ ุงูุดูุก ููุณู ูู GPU2 ุงูุฐู ูุญุตู ุนูู ุงูุฏูุนุฉ ุงููุตุบุฑุฉ x2. ูุญุตู ุนูู a0 ูa1 ูู GPU0 ูGPU1.

ุจูุฐู ุงูุทุฑููุฉุ ุชุญุตู ูู ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPUs ุงูุซูุงุซ ุนูู ุงูุชูุณูุฑุงุช ุงููุงููุฉ ุงููุนุงุฏ ุจูุงุคูุง ูุชููุฐ ุนูููุฉ ุงูุชูุงู ุฃูุงููุฉ ุจุงุณุชุฎุฏุงู ุงูุฏูุนุฉ ุงููุตุบุฑุฉ ุงูุฎุงุตุฉ ุจูุง. ุจูุฌุฑุฏ ุงูุงูุชูุงุก ูู ุงูุญุณุงุจุ ูุชู ุฅุณูุงุท ุงูุจูุงูุงุช ุงูุชู ูู ุชุนุฏ ููุงู ุญุงุฌุฉ ุฅูููุง - ูุชู ุงุณุชุฎุฏุงููุง ููุท ุฃุซูุงุก ุงูุญุณุงุจ. ุชุชู ุฅุนุงุฏุฉ ุงูุจูุงุก ุจููุงุกุฉ ุนุจุฑ ุงูุงุณุชุฑุฌุงุน ุงููุณุจู.

ุซู ุชุชูุฑุฑ ุงูุนูููุฉ ุจุฃููููุง ููุทุจูุฉ Lbุ ุซู Lc ููุฃูุงูุ ุซู ููุฎูู Lc -> Lb -> La.

<Tip>
ุชุชุดุงุจู ูุฐู ุงูุขููุฉ ูุน ุงุณุชุฑุงุชูุฌูุฉ ูุนุงูุฉ ูุฑุญูุงุช ุงูุชุฎููู ุงูุฌูุงุนูุฉ: ูุญูู ุงูุดุฎุต A ุงูุฎููุฉุ ููุญูู ุงูุดุฎุต B ุงููููุฏุ ููุญูู ุงูุดุฎุต C ุงููุฃุณ. ูู ูููุฉ ูุชุดุงุฑููู ูุง ูุฏููู ูุน ุงูุขุฎุฑูู ููุญุตููู ูู ุงูุขุฎุฑูู ุนูู ูุง ูุง ูููููููุ ููู ุงูุตุจุงุญ ูุญุฒููู ูุนุฏุงุชูู ุงููุฎุตุตุฉ ููุณุชูุฑูู ูู ุทุฑูููู. ูุฐุง ูู ูุง ูู ุนููู ZeRO DP/Sharded DDP.

ูุงุฑู ูุฐู ุงูุงุณุชุฑุงุชูุฌูุฉ ุจุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุจุณูุทุฉ ุญูุซ ูุชุนูู ุนูู ูู ุดุฎุต ุญูู ุฎููุชู ููููุฏู ููุฃุณู (ูุดุงุจู ูู DataParallel (DP ูDDP) ูู PyTorch)ุ ูุงูุชู ุณุชููู ุฃูู ููุงุกุฉ ุจูุซูุฑ.
</Tip>

ุนูุฏ ูุฑุงุกุฉ ุงูุฃุฏุจูุงุช ุญูู ูุฐุง ุงูููุถูุนุ ูุฏ ุชุตุงุฏู ุงููุฑุงุฏูุงุช ุงูุชุงููุฉ: Sharded ูPartitioned. ุฅุฐุง ููุช ุชููู ุงูุชูุงููุง ูุซูููุง ููุทุฑููุฉ ุงูุชู ุชูุณู ุจูุง ZeRO ุฃูุฒุงู ุงููููุฐุฌุ ูุณุชุจุฏู ูุดุงุจูุฉ ุฌุฏูุง ูููุงุฒุงุฉ ุงูุชูุณูุฑ ุงูุชู ุณูุชู ููุงูุดุชูุง ูุงุญููุง. ููุฑุฌุน ุฐูู ุฅูู ุฃููุง ุชูุณู/ุชุดุธู ุฃูุฒุงู ูู ุทุจูุฉุ ุนูู ุนูุณ ููุงุฒุงุฉ ุงููููุฐุฌ ุงูุฑุฃุณูุฉ ุงูุชู ุณูุชู ููุงูุดุชูุง ุจุนุฏ ุฐูู.

ุงูุชุทุจููุงุช:

- [DeepSpeed](https://www.deepspeed.ai/tutorials/zero/) ZeRO-DP ุงููุฑุงุญู 1+2+3
- ุชูุงูู [Accelerate](https://huggingface.co/docs/accelerate/en/usage_guides/deepspeed)
- ุชูุงูู [ุงููุญููุงุช](main_classes/trainer#trainer-integrations)
## ูู ุงููููุฐุฌ ุงูุณุงุฐุฌ ููุชูุงุฒู ุฅูู ุงูุชูุงุฒู ุงูุฃูุจูุจู

ูุดุฑุญ ุงูุชูุงุฒู ุงูุฃูุจูุจูุ ุณูููู ูุธุฑุฉ ุฃููุงู ุนูู ุงูุชูุงุฒู ุงูุณุงุฐุฌ ูููููุฐุฌ (MP)ุ ุงููุนุฑูู ุฃูุถูุง ุจุงุณู MP ุงูุฑุฃุณู. ูุชุถูู ูุฐุง ุงูููุฌ ุชูุฒูุน ูุฌููุนุงุช ูู ุทุจูุงุช ุงููููุฐุฌ ุนุจุฑ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ูุชุนุฏุฏุฉ ุนู ุทุฑูู ุชุนููู ุทุจูุงุช ูุญุฏุฏุฉ ุฅูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ูุญุฏุฏุฉ ุจุงุณุชุฎุฏุงู `.to()`.

ุจูููุง ุชูุชูู ุงูุจูุงูุงุช ุนุจุฑ ูุฐู ุงูุทุจูุงุชุ ูุชู ููููุง ุฅูู ููุณ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ูุซู ุงูุทุจูุฉุ ูู ุญูู ุชุธู ุงูุทุจูุงุช ุงูุฃุฎุฑู ุฏูู ุชุบููุฑ.

ูุดูุฑ ุฅูู ูุฐุง ุงูุชูุงุฒู ุงููููุฐุฌู ุจุงุณู "ุงูุฑุฃุณู" ุจุณุจุจ ุทุฑููุฉ ุชุตูุฑ ุงูููุงุฐุฌ ุนุงุฏุฉู. ุนูู ุณุจูู ุงููุซุงูุ ููุถุญ ุงููุฎุทุท ุงูุชุงูู ูููุฐุฌูุง ูููููุง ูู 8 ุทุจูุงุช ููุณูุฉ ุฑุฃุณูุงู ุฅูู ุดุฑูุญุชููุ ุญูุซ ูุชู ูุถุน ุงูุทุจูุงุช ูู 0 ุฅูู 3 ุนูู GPU0 ูุงูุทุจูุงุช ูู 4 ุฅูู 7 ุนูู GPU1:

ูู ูุฐุง ุงููุซุงูุ ุนูุฏูุง ุชูุชูู ุงูุจูุงูุงุช ูู ุงูุทุจูุฉ 0 ุฅูู ุงูุทุจูุฉ 3ุ ูุง ูุฎุชูู ุงูุฃูุฑ ุนู ุนูููุฉ ุงูุชุบุฐูุฉ ุงูุฃูุงููุฉ ุงูุนุงุฏูุฉ. ููุน ุฐููุ ูุชุทูุจ ุชูุฑูุฑ ุงูุจูุงูุงุช ูู ุงูุทุจูุฉ 3 ุฅูู ุงูุทุจูุฉ 4 ููููุง ูู GPU0 ุฅูู GPU1ุ ููุง ูุคุฏู ุฅูู ุฒูุงุฏุฉ ุงูุนุจุก ุนูู ุงูุงุชุตุงู. ุฅุฐุง ูุงูุช ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงููุดุงุฑูุฉ ููุฌูุฏุฉ ุนูู ููุณ ุนูุฏุฉ ุงูุญูุณุจุฉ (ูุซู ููุณ ุงูุฌูุงุฒ ุงููุงุฏู)ุ ูุฅู ุงููุณุฎ ูููู ุณุฑูุนูุงุ ูููู ุฅุฐุง ุชู ุชูุฒูุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุนุจุฑ ุนูุฏ ุญูุณุจุฉ ูุฎุชููุฉ (ูุซู ุฃุฌูุฒุฉ ูุชุนุฏุฏุฉ)ุ ููุฏ ูููู ุนุจุก ุงูุงุชุตุงู ุฃูุจุฑ ุจูุซูุฑ.

ุจุนุฏ ุฐููุ ุชุนูู ุงูุทุจูุงุช ูู 4 ุฅูู 7 ููุง ูู ูู ุงููููุฐุฌ ุงูุฃุตูู. ุจุนุฏ ุงูุงูุชูุงุก ูู ุงูุทุจูุฉ ุงูุณุงุจุนุฉุ ููุงู ุญุงุฌุฉ ุบุงูุจูุง ุฅูู ุฅุฑุณุงู ุงูุจูุงูุงุช ูุฑุฉ ุฃุฎุฑู ุฅูู ุงูุทุจูุฉ 0 ุญูุซ ุชูุฌุฏ ุงูุชุณููุงุช (ุฃู ุจุฏูุงู ูู ุฐูู ุฅุฑุณุงู ุงูุชุณููุงุช ุฅูู ุงูุทุจูุฉ ุงูุฃุฎูุฑุฉ). ุงูุขู ูููู ุญุณุงุจ ุงูุฎุณุงุฑุฉ ููููู ูููุญูุณููู ุงูููุงู ุจุนููู.

ูุนุงูู ุงูุชูุงุฒู ุงููููุฐุฌู ุงูุณุงุฐุฌ ูู ุนุฏุฉ ุฃูุฌู ูุตูุฑ:

- **ุฌููุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุจุงุณุชุซูุงุก ูุงุญุฏุฉ ุบูุฑ ูุดุทุฉ ูู ุฃู ููุช ูุนูู**: ุฅุฐุง ุชู ุงุณุชุฎุฏุงู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU)ุ ููุฐุง ูุดุงุจู ุชูุฑูุจูุง ููุถุงุนูุฉ ุญุฌู ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงููุฑุฏูุฉ ุจููุฏุงุฑ ุฃุฑุจุนุฉ ุฃุถุนุงูุ ูุชุฌุงูู ุจููุฉ ุงูุฃุฌูุฒุฉ.

- **ุงูุนุจุก ุงูุฒุงุฆุฏ ูู ููู ุงูุจูุงูุงุช ุจูู ุงูุฃุฌูุฒุฉ**: ุนูู ุณุจูู ุงููุซุงูุ ูููู ูู 4x 6GB cards ุงุณุชูุนุงุจ ููุณ ุงูุญุฌู ูุซู 1x 24GB card ุจุงุณุชุฎุฏุงู MP ุงูุณุงุฐุฌุ ูููู ุจุทุงูุฉ 24GB ูุงุญุฏุฉ ุณุชููู ุงูุชุฏุฑูุจ ุจุดูู ุฃุณุฑุนุ ูุฃููุง ูุง ุชุญุชูู ุนูู ุนุจุก ูุณุฎ ุงูุจูุงูุงุช. ููููุ ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ูุฏูู ุจุทุงูุงุช 40 ุฌูุฌุงุจุงูุช ูุชุญุชุงุฌ ุฅูู ูููุฐุฌ 45 ุฌูุฌุงุจุงูุชุ ูููููู ุฐูู ุจุงุณุชุฎุฏุงู 4x 40GB cards (ูููู ุจุงููุงุฏ ุจุณุจุจ ุญุงูุฉ ุงูุชุฏุฑุฌ ููุญุณู).

- **ูุณุฎ ุงูุชุนูููุงุช ุงูุชูุถูุญูุฉ ุงููุดุชุฑูุฉ**: ูุฏ ุชุญุชุงุฌ ุงูุชุนูููุงุช ุงูุชูุถูุญูุฉ ุงููุดุชุฑูุฉ ุฅูู ูุณุฎูุง ุฐูุงุจูุง ูุฅูุงุจูุง ุจูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU).

ุงูุขู ุจุนุฏ ุฃู ุชุนุฑูุช ุนูู ููููุฉ ุนูู ุงูููุฌ ุงูุณุงุฐุฌ ููุชูุงุฒู ุงููููุฐุฌู ูุฃูุฌู ุงููุตูุฑ ูููุ ุฏุนูุง ูููู ูุธุฑุฉ ุนูู ุงูุชูุงุฒู ุงูุฃูุจูุจู (PP).

PP ูุชุทุงุจู ุชูุฑูุจูุง ูุน MP ุงูุณุงุฐุฌุ ููููู ูุญู ูุดููุฉ ุนุฏู ูุดุงุท ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุนู ุทุฑูู ุชูุณูู ุงูุฏูุนุฉ ุงููุงุฑุฏุฉ ุฅูู ุฏูุนุงุช ุฏูููุฉ ูุฅูุดุงุก ุฎุท ุฃูุงุจูุจ ุจุดูู ูุตุทูุนุ ููุง ูุณูุญ ููุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงููุฎุชููุฉ ุจุงููุดุงุฑูุฉ ุงููุชุฒุงููุฉ ูู ุนูููุฉ ุงูุญุณุงุจ.

ููุถุญ ุงูุฑุณู ุงูุชุงูู ูู ูุฑูุฉ GPipe ุงูููุฌ ุงูุณุงุฐุฌ ูู MP ูู ุงูุฃุนููุ ู PP ูู ุงูุฃุณูู:

ูู ุฃุณูู ุงููุฎุทุทุ ููููู ููุงุญุธุฉ ุฃู ููุฌ ุงูุชูุงุฒู ุงูุฃูุจูุจู (PP) ูููู ูู ุนุฏุฏ ููุงุทู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุบูุฑ ุงููุดุทุฉุ ุงููุดุงุฑ ุฅูููุง ุจุงุณู "ุงูููุงุนุงุช". ููุถุญ ููุง ุฌุฒุฃู ุงููุฎุทุท ูุณุชูู ุชูุงุฒู ูู ุงูุฏุฑุฌุฉ 4ุ ููุง ูุนูู ุฃู ููุงู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุชุดุงุฑู ูู ุฎุท ุงูุฃูุงุจูุจ. ููููู ุฃู ุชุฑู ุฃู ููุงู ูุณุงุฑูุง ููุฃูุงู ูููููุง ูู 4 ูุฑุงุญู ุฃูุงุจูุจ (F0ุ F1ุ F2ุ ู F3) ูููู ูุณุงุฑ ุนูุณู ุจุงูุชุฑุชูุจ ุงูุนูุณู (B3ุ B2ุ B1ุ ู B0).

ููุฏู PP ููุนูุงููููุฉ ุฌุฏูุฏุฉ ููุถุจุท - "chunks"ุ ูุงูุชู ุชุญุฏุฏ ุนุฏุฏ ูุทุน ุงูุจูุงูุงุช ุงููุฑุณูุฉ ูู ุชุณูุณู ุนุจุฑ ููุณ ูุฑุญูุฉ ุงูุฃูุจูุจ. ุนูู ุณุจูู ุงููุซุงูุ ูู ุงููุฎุทุท ุงูุณูููุ ููููู ุฑุคูุฉ "chunks=4". ุชููู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU0) ุจููุณ ุงููุณุงุฑ ุงูุฃูุงูู ุนูู ุงูุฌุฒุก 0 ู 1 ู 2 ู 3 (F0ุ0ุ F0ุ1ุ F0ุ2ุ F0ุ3) ุซู ุชูุชุธุฑ ุญุชู ุชูุชูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงูุฃุฎุฑู ูู ุนูููุง. ูุง ุชุจุฏุฃ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU0) ูู ุงูุนูู ูุฑุฉ ุฃุฎุฑู ุฅูุง ุนูุฏูุง ุชุจุฏุฃ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงูุฃุฎุฑู ูู ุฅููุงู ุนูููุงุ ูุชููู ุจูุณุงุฑ ุงูุนูุฏุฉ ูููุทุน 3 ู 2 ู 1 ู 0 (B0ุ3ุ B0ุ2ุ B0ุ1ุ B0ุ0).

ูุงุญุธ ุฃู ูุฐุง ูู ููุณ ููููู ุฎุทูุงุช ุชุฌููุน ุงูุชุฏุฑุฌุงุช. ูุณุชุฎุฏู PyTorch "chunks"ุ ุจูููุง ูุดูุฑ DeepSpeed ุฅูู ููุณ ููุนูุงููููุฉ ุงูุถุจุท ุนูู ุฃููุง ุฎุทูุงุช ุชุฌููุน ุงูุชุฏุฑุฌุงุช.

ุจุณุจุจ "chunks"ุ ููุฏู PP ููููู ุงูุฏูุนุงุช ุงูุฏูููุฉ (MBS). ูููู DP ุจุชูุณูู ุญุฌู ุฏูุนุฉ ุงูุจูุงูุงุช ุงูุนุงูููุฉ ุฅูู ุฏูุนุงุช ุตุบูุฑุฉุ ูุฐุง ุฅุฐุง ูุงู ูุฏูู ุฏุฑุฌุฉ DP ุชุจูุบ 4ุ ูุชู ุชูุณูู ุญุฌู ุฏูุนุฉ ุนุงูููุฉ ุชุจูุบ 1024 ุฅูู 4 ุฏูุนุงุช ุตุบูุฑุฉ ูุจูุบ ุญุฌู ูู ูููุง 256 (1024/4). ูุฅุฐุง ูุงู ุนุฏุฏ "chunks" (ุฃู GAS) ูู 32ุ ูุฅููุง ููุชูู ุจุญุฌู ุฏูุนุฉ ุฏูููุฉ ูุจูุบ 8 (256/32). ุชุนูู ูู ูุฑุญูุฉ ูู ูุฑุงุญู ุงูุฃูุงุจูุจ ูุน ุฏูุนุฉ ุฏูููุฉ ูุงุญุฏุฉ ูู ูู ูุฑุฉ. ูุญุณุงุจ ุญุฌู ุงูุฏูุนุฉ ุงูุนุงูููุฉ ูุฅุนุฏุงุฏ DP + PPุ ุงุณุชุฎุฏู ุงูุตูุบุฉ: "mbs * chunks * dp_degree" ("8 * 32 * 4 = 1024").

ูุน "chunks=1"ุ ููุชูู ุจู ุงูุฃูุฑ ุจู MP ุงูุณุงุฐุฌุ ููู ุบูุฑ ูุนุงู. ูุน ูููุฉ ูุจูุฑุฉ ูู "chunks"ุ ููุชูู ุจู ุงูุฃูุฑ ุจุญุฌู ุฏูุนุงุช ุฏูููุฉ ุตุบูุฑุฉุ ููู ุฃูุถูุง ุบูุฑ ูุนุงู. ููุฐุง ุงูุณุจุจุ ูุดุฌุนู ุนูู ุชุฌุฑุจุฉ ูููุฉ "chunks" ููุนุซูุฑ ุนูู ุงููููุฉ ุงูุชู ุชุคุฏู ุฅูู ุฃูุซุฑ ุงุณุชุฎุฏุงู ูุนุงู ููุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU).

ูุฏ ุชูุงุญุธ ูุฌูุฏ "ููุงุนุฉ" ูู ุงูููุช "ุงูููุช" ุนูู ุงููุฎุทุท ุงูุฐู ูุง ูููู ุชุญูููู ุฅูู ุชูุงุฒู ูุฃู ูุฑุญูุฉ "ุงูุชุบุฐูุฉ ุงูุฃูุงููุฉ" ุงูุฃุฎูุฑุฉ ูุฌุจ ุฃู ุชูุชุธุฑ ุงูุชูุงู "ุงูุนูุฏุฉ" ูุฅููุงู ุฎุท ุงูุฃูุงุจูุจ. ุงูุบุฑุถ ูู ุงูุนุซูุฑ ุนูู ุฃูุถู ูููุฉ ูู "chunks" ูู ุชูููู ุงุณุชุฎุฏุงู ูุชุฒุงูู ุนุงูู ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุนุจุฑ ุฌููุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ุงููุดุงุฑูุฉุ ููุง ูุคุฏู ุฅูู ุชูููู ุญุฌู "ุงูููุงุนุฉ".

ุชู ุชูููุฐ ุญููู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API) ุงูุฎุงุตุฉ ุจุฎุท ุงูุฃูุงุจูุจ ูู:

- PyTorch
- DeepSpeed
- Megatron-LM

ุชุฃุชู ูุฐู ุงูุญููู ุจุจุนุถ ุฃูุฌู ุงููุตูุฑ:

- ูุฌุจ ุฃู ุชุนุฏู ุงููููุฐุฌ ุจุดูู ูุจูุฑุ ูุฃู ุฎุท ุงูุฃูุงุจูุจ ูุชุทูุจ ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุชุฏูู ุงูุทุจูุนู ูููุญุฏุงุช ุงูููุทูุฉ ุฅูู ุชุณูุณู "nn.Sequential" ูู ููุณ ุงูููุนุ ูุงูุฐู ูุฏ ูุชุทูุจ ุฅุฌุฑุงุก ุชุบููุฑุงุช ุนูู ุชุตููู ุงููููุฐุฌ.

- ุญุงูููุงุ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช (API) ุงูุฎุงุตุฉ ุจุฎุท ุงูุฃูุงุจูุจ ูููุฏุฉ ููุบุงูุฉ. ุฅุฐุง ูุงู ูุฏูู ูุฌููุนุฉ ูู ูุชุบูุฑุงุช Python ุงูุชู ูุชู ุชูุฑูุฑูุง ูู ุงููุฑุญูุฉ ุงูุฃููู ูู ุฎุท ุงูุฃูุงุจูุจุ ูุณูู ูุชุนูู ุนููู ุฅูุฌุงุฏ ุทุฑููุฉ ููุงูุชูุงู ุนูููุง. ุญุงูููุงุ ูุชุทูุจ ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช (API) ุงูุฎุงุตุฉ ุจุฎุท ุงูุฃูุงุจูุจ ุฅูุง Tensor ูุงุญุฏ ุฃู ูุฌููุนุฉ ูู Tensors ูุฅุฏุฎุงู ูุฅุฎุฑุงุฌ ูุญูุฏูู. ูุฌุจ ุฃู ูููู ููุฐู ุงููุตูููุงุช ุญุฌู ุฏูุนุฉ ูุฃูู ุจูุนุฏุ ูุธุฑูุง ูุฃู ุฎุท ุงูุฃูุงุจูุจ ุณูููู ุจุชูุณูู ุงูุฏูุนุฉ ุงููุตุบุฑุฉ ุฅูู ุฏูุนุงุช ุฏูููุฉ. ุชุชู ููุงูุดุฉ ุงูุชุญุณููุงุช ุงููุญุชููุฉ ููุง https://github.com/pytorch/pytorch/pull/50693

- ูุง ูููู ุฅุฌุฑุงุก ุชุฏูู ุงูุชุญูู ุงูุดุฑุทู ุนูู ูุณุชูู ูุฑุงุญู ุงูุฃูุงุจูุจ - ุนูู ุณุจูู ุงููุซุงูุ ุชุชุทูุจ ููุงุฐุฌ Encoder-Decoder ูุซู T5 ุญููููุง ุฎุงุตุฉ ููุชุนุงูู ูุน ูุฑุญูุฉ ุชุดููุฑ ุดุฑุทูุฉ.

- ูุฌุจ ุฃู ุชููู ุจุชุฑุชูุจ ูู ุทุจูุฉ ุจุญูุซ ูุตุจุญ ุฅุฎุฑุงุฌ ุฅุญุฏู ุงูุทุจูุงุช ุฅุฏุฎุงููุง ููุทุจูุฉ ุงูุฃุฎุฑู.

ุชุดูู ุงูุญููู ุงูุฃุญุฏุซ ูุง ููู:

- Varuna
- Sagemaker

ูู ูุฌุฑุจ Varuna ู SageMaker ูููู ุชุดูุฑ ุฃูุฑุงูููุง ุฅูู ุฃูููุง ุชุบูุจุง ุนูู ูุงุฆูุฉ ุงููุดููุงุช ุงููุฐููุฑุฉ ุฃุนูุงู ูุฃูููุง ูุชุทูุจุงู ุฅุฌุฑุงุก ุชุบููุฑุงุช ุฃูู ุนูู ูููุฐุฌ ุงููุณุชุฎุฏู.

ุงูุชุทุจููุงุช:

- [PyTorch](https://pytorch.org/docs/stable/pipeline.html) (ุฏุนู ุฃููู ูู pytorch-1.8ุ ูุชุญุณููู ุชุฏุฑูุฌููุง ูู 1.9 ูุจุดูู ุฃูุจุฑ ูู 1.10). ุจุนุถ [ุงูุฃูุซูุฉ](https://github.com/pytorch/pytorch/blob/master/benchmarks/distributed/pipeline/pipe.py)

- [DeepSpeed](https://www.deepspeed.ai/tutorials/pipeline/)

- [Megatron-LM](https://github.com/NVIDIA/Megatron-LM) ูุฏูู ุชูููุฐ ุฏุงุฎูู - ูุง ููุฌุฏ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช (API).

- [Varuna](https://github.com/microsoft/varuna)

- [SageMaker](https://arxiv.org/abs/2111.05972) - ูุฐุง ุญู ููููู ูุง ูููู ุงุณุชุฎุฏุงูู ุฅูุง ุนูู AWS.

- [OSLO](https://github.com/tunib-ai/oslo) - ุชู ุชูููุฐู ูุฐุง ุจูุงุกู ุนูู ูุญููุงุช Hugging Face.

ุญุงูุฉ ูุญููุงุช ๐ค : ุงุนุชุจุงุฑูุง ูู ููุช ูุชุงุจุฉ ูุฐุง ุงูุชูุฑูุฑุ ูุง ูุฏุนู ุฃู ูู ุงูููุงุฐุฌ PP ุงููุงูู. ุชูุชูู ููุงุฐุฌ GPT2 ู T5 ุฏุนู MP ุงูุณุงุฐุฌ.

ุงูุนูุจุฉ ุงูุฑุฆูุณูุฉ ูู ุนุฏู ุงููุฏุฑุฉ ุนูู ุชุญููู ุงูููุงุฐุฌ ุฅูู "nn.Sequential" ูุฌุนู ุฌููุน ุงูุฅุฏุฎุงูุงุช Tensors. ูุฑุฌุน ุฐูู ุฅูู ุฃู ุงูููุงุฐุฌ ุชุญุชูู ุญุงูููุง ุนูู ุงูุนุฏูุฏ ูู ุงูููุฒุงุช ุงูุชู ุชุฌุนู ุงูุชุญููู ูุนูุฏูุง ููุบุงูุฉุ ูุณูุชุนูู ุฅุฒุงูุชูุง ูุชุญููู ุฐูู.

ุชุชููุฑ ุนูููุงุช ุฏูุฌ DeepSpeed ู Megatron-LM ูู [๐ค Accelerate](https://huggingface.co/docs/accelerate/main/en/usage_guides/deepspeed)

ุงูููุฌ ุงูุฃุฎุฑู:

ูุณุชุฎุฏู DeepSpeed ู Varuna ู SageMaker ููููู [ุฎุท ุงูุฃูุงุจูุจ ุงููุชุดุงุจู](https://docs.aws.amazon.com/sagemaker/latest/dg/model-parallel-core-features.html)

ููุง ูุชู ุชูููู "ุงูููุงุนุฉ" (ุงูููุช ุบูุฑ ุงููุดุท) ุฃูุซุฑ ุนู ุทุฑูู ุฅุนุทุงุก ุงูุฃููููุฉ ูุนูููุงุช ุงูุนูุฏุฉ. ุชุญุงูู Varuna ูุฐูู ุชุญุณูู ุงูุฌุฏูู ุงูุฒููู ุจุงุณุชุฎุฏุงู ุงููุญุงูุงุฉ ููุนุซูุฑ ุนูู ุงูุฌุฏูู ุงูุฃูุซุฑ ููุงุกุฉ.

ูุญุชูู OSLO ุนูู ุชูููุฐ ููุชูุงุฒู ุงูุฃูุจูุจู ุจูุงุกู ุนูู ุงููุญููุงุช ุฏูู ุชุญููู "nn.Sequential".
## ุชูุงุฒู ุงููุตูููุงุช 

ูู ุชูุงุฒู ุงููุตูููุงุชุ ุชููู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณูููุฉ ุจูุนุงูุฌุฉ ุดุฑูุญุฉ ูู ุงููุตูููุฉ ููุง ุชุฌูุน ุงููุตูููุฉ ุงููุงููุฉ ุฅูุง ููุนูููุงุช ุงูุชู ุชุชุทูุจ ุฐูู. ูููุตู ูุฐู ุงูุทุฑููุฉุ ูุนุชูุฏ ูุฐุง ุงููุณู ูู ุงูุฏููู ุนูู ุงูููุงููู ูุงูุฑุณูู ุงูุจูุงููุฉ ูู ูุฑูุฉ Megatron-LM: ุงูุชุฏุฑูุจ ุงููุนุงู ููููุฐุฌ ุงููุบุฉ ูุงุณุน ุงููุทุงู ุนูู ูุฌููุนุงุช ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช.

ุงููุชูุฉ ุงูุฃุณุงุณูุฉ ูุฃู ูุญูู ูู ุทุจูุฉ ูุชุตูุฉ ุชูุงููุง ุชูููุง ุชูุดูุท ุบูุฑ ุฎุทู. ููููู ูุชุงุจุฉ ุงูุฌุฒุก ุงูููุทู ูู ุงูุถุฑุจ ุงูููุทูุ ุจุงุชุจุงุน ุชุฑููุฒ ูุฑูุฉ Megatronุ ุนูู ุงููุญู ุงูุชุงูู: Y = GeLU(XA)ุ ุญูุซ X ูู ูุชุฌู ุงูุฅุฏุฎุงูุ ูY ูู ูุชุฌู ุงูุฅุฎุฑุงุฌุ ูA ูู ูุตูููุฉ ุงูุฃูุฒุงู.

ุฅุฐุง ูุธุฑูุง ุฅูู ุงูุญุณุงุจ ูู ุดูู ูุตูููุฉุ ูููููู ุฃู ุชุฑู ููู ูููู ุชูุณูู ุนูููุฉ ุถุฑุจ ุงููุตูููุงุช ุจูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ ูุชุนุฏุฏุฉ:

ุฅุฐุง ูููุง ุจุชูุณูู ูุตูููุฉ ุงูุฃูุฒุงู A ุนูู ุดูู ุฃุนูุฏุฉ ุนุจุฑ N ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช ูุฃุฏุงุก ุนูููุงุช ุถุฑุจ ุงููุตูููุงุช XA_1 ูู ุฎูุงู XA_n ุจุงูุชูุงุฒูุ ูุณูุญุตู ุนูู ู ูุชุฌูุงุช ุฅุฎุฑุงุฌ Y_1ุ Y_2ุ ..., Y_n ูุงูุชู ูููู ุฅุฏุฎุงููุง ูู GeLU ุจุดูู ูุณุชูู:

ุจุงุณุชุฎุฏุงู ูุฐุง ุงููุจุฏุฃุ ูููููุง ุชุญุฏูุซ ุดุจูุฉ ุนุตุจูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช ุฐุงุช ุนูู ุนุดูุงุฆูุ ุฏูู ุงูุญุงุฌุฉ ุฅูู ุฃู ุชุฒุงูู ุจูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช ุญุชู ุงูููุงูุฉุ ุญูุซ ูุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุจูุงุก ูุชุฌู ุงูุฅุฎุฑุงุฌ ูู ุงูุดุธุงูุง. ูููุฏู ูุคููู ูุฑูุฉ Megatron-LM ุชูุถูุญูุง ูููุฏูุง ูุฐูู:

ุฅู ุฌุนู ุทุจูุงุช ุงูุงูุชูุงู ูุชุนุฏุฏ ุงูุฑุคูุณ ุฃูุซุฑ ุจุณุงุทุฉุ ูุฃููุง ูุชูุงุฒูุฉ ุจุงููุนู ุจุทุจูุนุชูุงุ ูุฐูู ุจุณุจุจ ูุฌูุฏ ุฑุคูุณ ูุณุชููุฉ ูุชุนุฏุฏุฉ!

ุงุนุชุจุงุฑุงุช ุฎุงุตุฉ: ูุชุทูุจ ุชูุงุฒู ุงููุตูููุงุช ุดุจูุฉ ุณุฑูุนุฉ ููุบุงูุฉุ ูุฐูู ูุง ูููุตุญ ุจุงูููุงู ุจุชูุงุฒู ุงููุตูููุงุช ุนุจุฑ ุฃูุซุฑ ูู ุนูุฏุฉ ูุงุญุฏุฉ. ููู ุงููุงุญูุฉ ุงูุนูููุฉุ ุฅุฐุง ูุงูุช ุงูุนูุฏุฉ ุชุญุชูู ุนูู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉุ ูุฅู ุฃุนูู ุฏุฑุฌุฉ ูู ุชูุงุฒู ุงููุตูููุงุช ูู 4. ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ุฏุฑุฌุฉ ุชูุงุฒู ูุตูููุงุช ุชุจูุบ 8ุ ููุฌุจ ุนููู ุงุณุชุฎุฏุงู ุงูุนูุฏ ุงูุชู ุชุญุชูู ุนูู 8 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ ุนูู ุงูุฃูู.

## ุชูุงุฒู ุงูุจูุงูุงุช + ุชูุงุฒู ุงูุฃูุงุจูุจ 

ููุถุญ ุงูุฑุณู ุงูุจูุงูู ุงูุชุงูู ูู ุชุนูููู DeepSpeed ููููุฉ ุงูุฌูุน ุจูู ุชูุงุฒู ุงูุจูุงูุงุช ูุน ุชูุงุฒู ุงูุฃูุงุจูุจ.

ูู ุงูููู ููุง ููุงุญุธุฉ ููู ุฃู ุชุฑุชูุจ ุชูุงุฒู ุงูุจูุงูุงุช 0 ูุง ูุฑู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช 2 ูุชุฑุชูุจ ุชูุงุฒู ุงูุจูุงูุงุช 1 ูุง ูุฑู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช 3. ูุจุงููุณุจุฉ ูุชูุงุฒู ุงูุจูุงูุงุชุ ููุงู ููุท ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช 0 ู1 ุญูุซ ูุชู ุฅุฏุฎุงู ุงูุจูุงูุงุช ููุง ูู ูุงู ููุงู ูุญุฏุชุงู ููุท ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช. ูุชููู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช 0 ุจุชูุฑูุบ ุจุนุถ ุญูููุชูุง ุณุฑุงู ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช 2 ุจุงุณุชุฎุฏุงู ุชูุงุฒู ุงูุฃูุงุจูุจ. ูุชููู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช 1 ุจููุณ ุงูุดูุก ุนู ุทุฑูู ุงูุงุณุชุนุงูุฉ ุจูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณูููุงุช 3.

ูุจูุง ุฃู ูู ุจูุนุฏ ูุชุทูุจ ูุญุฏุชู ูุนุงูุฌุฉ ุฑุณูููุฉ ุนูู ุงูุฃููุ ูุณุชุญุชุงุฌ ููุง ุฅูู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ ุนูู ุงูุฃูู.

## ุชูุงุฒู ุงูุจูุงูุงุช + ุชูุงุฒู ุงูุฃูุงุจูุจ + ุชูุงุฒู ุงููุตูููุงุช 

ููุญุตูู ุนูู ุชุฏุฑูุจ ุฃูุซุฑ ููุงุกุฉุ ูุชู ุงุณุชุฎุฏุงู ุชูุงุฒู ุซูุงุซู ุงูุฃุจุนุงุฏ ุญูุซ ูุชู ุงูุฌูุน ุจูู ุชูุงุฒู ุงูุฃูุงุจูุจ ูุน ุชูุงุฒู ุงููุตูููุงุช ูุชูุงุฒู ุงูุจูุงูุงุช. ููููู ููุงุญุธุฉ ุฐูู ูู ุงูุฑุณู ุงูุจูุงูู ุงูุชุงูู.

ูุฐุง ุงูุฑุณู ุงูุจูุงูู ูุฃุฎูุฐ ูู ููุดูุฑ ูุฏููุฉ ุจุนููุงู "ุชูุงุฒู ุซูุงุซู ุงูุฃุจุนุงุฏ: ุชูุณูุน ูุทุงู ุงูููุงุฐุฌ ุฅูู ููุงุฐุฌ ูุนููุงุช ุงูุชุฑููููู"ุ ููู ุฃูุถูุง ูุฑุงุกุฉ ุฌูุฏุฉ.

ูุจูุง ุฃู ูู ุจูุนุฏ ูุชุทูุจ ูุญุฏุชู ูุนุงูุฌุฉ ุฑุณูููุฉ ุนูู ุงูุฃููุ ูุณุชุญุชุงุฌ ููุง ุฅูู 8 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ ุนูู ุงูุฃูู.

## ุชูุงุฒู ุจูุงูุงุช Zero + ุชูุงุฒู ุงูุฃูุงุจูุจ + ุชูุงุฒู ุงููุตูููุงุช 

ูู ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ ูุจุฑูุงูุฌ DeepSpeed ูู Zeroุ ููู ุงูุชุฏุงุฏ ูุงุจู ููุชุทููุฑ ููุบุงูุฉ ูุชูุงุฒู ุงูุจูุงูุงุช. ููุฏ ุชูุช ููุงูุดุชู ุจุงููุนู ูู ูุณู "ุชูุงุฒู ุจูุงูุงุช Zero". ูุนุงุฏุฉ ูุง ูููู ููุฒุฉ ูุณุชููุฉ ูุง ุชุชุทูุจ ุชูุงุฒู ุงูุฃูุงุจูุจ ุฃู ุชูุงุฒู ุงููุตูููุงุช. ููููู ูููู ุฃู ูุฌูุน ูุน ุชูุงุฒู ุงูุฃูุงุจูุจ ูุชูุงุฒู ุงููุตูููุงุช.

ุนูุฏูุง ูุชู ุงูุฌูุน ุจูู Zero-DP ูุน PP (ูุจุดูู ุงุฎุชูุงุฑู TP)ุ ูุฅูู ููููู ุนุงุฏุฉู ูู Zero stage 1 (ุชุฌุฒุฆุฉ ุงููุญุณู) ููุท.

ูู ุญูู ุฃูู ูู ุงููููู ูุธุฑููุง ุงุณุชุฎุฏุงู Zero stage 2 (ุชุฌุฒุฆุฉ ุงูุชุฏุฑุฌ) ูุน ุชูุงุฒู ุงูุฃูุงุจูุจุ ุฅูุง ุฃูู ุณูููู ูู ุชุฃุซูุฑุงุช ุณูุจูุฉ ุนูู ุงูุฃุฏุงุก. ุณูููู ููุงู ุญุงุฌุฉ ุฅูู ุชูููู ุฅุถุงูู ูููุฌููุนุฉ ููู ุฏูุนุฉ ุตุบูุฑุฉ ูุฌูุน ุงูุชุฏุฑุฌุงุช ูุจู ุงูุชุฌุฒุฆุฉุ ููุง ูุถูู ุชูููุฉ ุงุชุตุงู ูุญุชููุฉ ูุจูุฑุฉ. ูุจุณุจุจ ุทุจูุนุฉ ุชูุงุฒู ุงูุฃูุงุจูุจุ ูุชู ุงุณุชุฎุฏุงู ุฏูุนุงุช ุตุบูุฑุฉ ูุชุญุงูู ููุงุฒูุฉ ูุซุงูุฉ ุงูุญุณุงุจ (ุญุฌู ุงูุฏูุนุฉ ุงูุตุบูุฑุฉ) ูุน ุชูููู ููุงุนุฉ ุงูุฃูุงุจูุจ (ุนุฏุฏ ุงูุฏูุนุงุช ุงูุตุบูุฑุฉ). ูุฐูู ุณุชุคุซุฑ ุชูุงููู ุงูุงุชุตุงู ูุฐู ุนูู ุงูุฃุฏุงุก.

ุจุงูุฅุถุงูุฉ ุฅูู ุฐููุ ููุงู ุจุงููุนู ุทุจูุงุช ุฃูู ูู ุงููุนุชุงุฏ ุจุณุจุจ ุชูุงุฒู ุงูุฃูุงุจูุจุ ูุฐูู ูู ุชููู ูููุฑุงุช ุงูุฐุงูุฑุฉ ูุจูุฑุฉ. ููููู ุชูุงุฒู ุงูุฃูุงุจูุจ ุจุงููุนู ูู ุญุฌู ุงูุชุฏุฑุฌ ุจูุณุจุฉ 1/PPุ ูุฐูู ูุฅู ูููุฑุงุช ุชุฌุฒุฆุฉ ุงูุชุฏุฑุฌ ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุฃูู ุฃูููุฉ ูู ุชูุงุฒู ุงูุจูุงูุงุช ุงูููู.

ููุง ุฃู Zero stage 3 ููุณ ุฎูุงุฑูุง ุฌูุฏูุง ูููุณ ุงูุณุจุจ - ุงูุญุงุฌุฉ ุฅูู ูุฒูุฏ ูู ุงูุงุชุตุงูุงุช ุจูู ุงูุนูุฏ.

ูุจูุง ุฃููุง ูุฏููุง Zeroุ ูุฅู ุงููุงุฆุฏุฉ ุงูุฃุฎุฑู ูู Zero-Offload. ูุจูุง ุฃู ูุฐู ูู ูุฑุญูุฉ 1ุ ูููู ุชูุฑูุบ ุญุงูุงุช ุงููุญุณู ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ.
## FlexFlow

ููุฏู FlexFlow ุฃูุถูุง ุญูุงู ููุดููุฉ ุงูููุงุฒุงุฉ ุจุทุฑููุฉ ูุฎุชููุฉ ููููุงู.

ูููู ุจุชูููุฐ ููุน ูู ุงูููุงุฒุงุฉ ุฑุจุงุนูุฉ ุงูุฃุจุนุงุฏ ุนูู Sample-Operator-Attribute-Parameter.

1. ุงูุนููุฉ = ุงูููุงุฒุงุฉ ุนูู ูุณุชูู ุงูุจูุงูุงุช (ููุงุฒุงุฉ ุนูู ูุณุชูู ุงูุนููุงุช)
2. ุงููุดุบู = ููุงุฒุงุฉ ุนูููุฉ ูุงุญุฏุฉ ุฅูู ุนุฏุฉ ุนูููุงุช ูุฑุนูุฉ
3. ุงูุตูุฉ = ุงูููุงุฒุงุฉ ุนูู ูุณุชูู ุงูุจูุงูุงุช (ููุงุฒุงุฉ ุนูู ูุณุชูู ุงูุทูู)
4. ุงููุนุงูู = ููุงุฒุงุฉ ุงููููุฐุฌ (ุจุบุถ ุงููุธุฑ ุนู ุงูุจุนุฏ - ุฃููู ุฃู ุฑุฃุณู)

ุงูุฃูุซูุฉ:

* ุงูุนููุฉ

ููุฃุฎุฐ 10 ุฏูุนุงุช ุจุทูู ุชุณูุณู 512. ุฅุฐุง ูููุง ุจููุงุฒุงุฉ ุงูุจุนุฏ ุฅูู ุฌูุงุฒููุ ูุณูุญุตู ุนูู 10 ร 512 ูุงูุชู ุชุตุจุญ 5 ร 2 ร 512.

* ุงููุดุบู

ุฅุฐุง ุฃุฌุฑููุง ุชุทุจูุน ุงูุทุจูุฉุ ูุฅููุง ูุญุณุจ ุงูุงูุญุฑุงู ุงููุนูุงุฑู ุฃููุงู ุซู ุงููุชูุณุทุ ูุจุนุฏ ุฐูู ูููููุง ุชุทุจูุน ุงูุจูุงูุงุช. ุชุณูุญ ููุงุฒุงุฉ ุงููุดุบู ุจุญุณุงุจ ุงูุงูุญุฑุงู ุงููุนูุงุฑู ูุงููุชูุณุท โโุจุงูุชูุงุฒู. ูุฐููุ ุฅุฐุง ูููุง ุจููุงุฒุงุฉ ุงูุจุนุฏ ุฅูู ุฌูุงุฒูู (cuda:0ุ cuda:1)ุ ููุญู ูููู ุฃููุงู ุจูุณุฎ ุจูุงูุงุช ุงูุฅุฏุฎุงู ุฅูู ููุง ุงูุฌูุงุฒููุ ููููู cuda:0 ุจุญุณุงุจ ุงูุงูุญุฑุงู ุงููุนูุงุฑูุ ููููู cuda:1 ุจุญุณุงุจ ุงููุชูุณุท โโูู ููุณ ุงูููุช.

* ุงูุตูุฉ

ูุฏููุง 10 ุฏูุนุงุช ุจุทูู 512. ุฅุฐุง ูููุง ุจููุงุฒุงุฉ ุงูุจุนุฏ ุฅูู ุฌูุงุฒููุ ูุณุชููู 10 ร 512 ูู 10 ร 2 ร 256.

* ุงููุนุงูู

ููู ูุดุงุจู ูููุงุฒุงุฉ ูููุฐุฌ Tensor ุฃู ููุงุฒุงุฉ ุทุจูุฉ Naive.

ุชููู ุฃูููุฉ ูุฐุง ุงูุฅุทุงุฑ ูู ุฃูู ูุฃุฎุฐ ุงูููุงุฑุฏ ูุซู (1) GPU/TPU/CPU ููุงุจู (2) RAM/DRAM ููุงุจู (3) fast-intra-connect/slow-inter-connect ููููู ุชููุงุฆููุง ุจุชุญุณูููุง ุฌููุนูุง ุฎูุงุฑุฒูููุงุ ูููุฑุฑ ุฃู ููุงุฒุงุฉ ูุฌุจ ุงุณุชุฎุฏุงููุง ูุฃูู.

ูู ุงูุฌูุงูุจ ุงููููุฉ ุฌุฏูุง ุฃู FlexFlow ูุตูู ูุชุญุณูู ููุงุฒุงุฉ DNN ููููุงุฐุฌ ุฐุงุช ุงูุฃุญูุงู ุงูุนููุฉ ุงูุซุงุจุชุฉ ูุงูุซุงุจุชุฉุ ุญูุซ ูุฏ ุชูุถู ุงูููุงุฐุฌ ุฐุงุช ุงูุณููู ุงูุฏููุงูููู ุงุณุชุฑุงุชูุฌูุงุช ููุงุฒุงุฉ ูุฎุชููุฉ ุนุจุฑ ุงูุชูุฑุงุฑุงุช.

ูุฐููุ ุงููุนุฏ ุฌุฐุงุจ ููุบุงูุฉ - ููู ูููู ุจุชุดุบูู ูุญุงูุงุฉ ููุฏุฉ 30 ุฏูููุฉ ุนูู ูุฌููุนุฉ ูู ุงุฎุชูุงุฑู ููุฎุฑุฌ ุจุฃูุถู ุงุณุชุฑุงุชูุฌูุฉ ูุงุณุชุฎุฏุงู ูุฐู ุงูุจูุฆุฉ ุงููุญุฏุฏุฉ. ุฅุฐุง ููุช ุจุฅุถุงูุฉ/ุฅุฒุงูุฉ/ุงุณุชุจุฏุงู ุฃู ุฃุฌุฒุงุกุ ูุณูููู ุจุชุดุบูููุง ูุฅุนุงุฏุฉ ุชุญุณูู ุงูุฎุทุฉ ูุฐูู. ูุจุนุฏ ุฐูู ููููู ุงูุชุฏุฑูุจ. ุณูููู ููุฅุนุฏุงุฏ ุงููุฎุชูู ุชุญุณููู ุงููุฎุตุต.

ุญุงูุฉ ุงููุญููุงุช: ูููู ุชุชุจุน ููุงุฐุฌ ุงููุญููุงุช ุนุจุฑ transformers.utils.fxุ ููู ุดุฑุท ุฃุณุงุณู ูู FlexFlowุ ูููู ููุฒู ุฅุฌุฑุงุก ุชุบููุฑุงุช ุนูู ุฌุงูุจ FlexFlow ูุฌุนูู ูุนูู ูุน ููุงุฐุฌ ุงููุญููุงุช.

## ุงุฎุชูุงุฑ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU)

ุนูุฏ ุงูุชุฏุฑูุจ ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ูุชุนุฏุฏุฉุ ููููู ุชุญุฏูุฏ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง ูุงูุชุฑุชูุจ ุงูุฐู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง ุจู. ูููู ุฃู ูููู ุฐูู ูููุฏูุงุ ุนูู ุณุจูู ุงููุซุงูุ ุนูุฏูุง ูููู ูุฏูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ุฐุงุช ูุฏุฑุงุช ุญูุณุจุฉ ูุฎุชููุฉ ูุชุฑูุฏ ุงุณุชุฎุฏุงู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุฃุณุฑุน ุฃููุงู. ุชูุทุจู ุนูููุฉ ุงูุงุฎุชูุงุฑ ุนูู ูู ูู DistributedDataParallel ู DataParallel ูุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑุนูุฉ ููุท ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงููุชููุฑุฉุ ููุง ุชุญุชุงุฌ ุฅูู Accelerate ุฃู ุชูุงูู DeepSpeed.

### ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU)

ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ูุฏูู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ูุชุฑูุฏ ุงุณุชุฎุฏุงู ุฃูู ุงุซูุชูู ููุท:

- ุงุณุชุฎุฏู --nproc_per_node ูุชุญุฏูุฏ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง.

```bash
torchrun --nproc_per_node=2 trainer-program.py ...
```

- ุงุณุชุฎุฏู --num_processes ูุชุญุฏูุฏ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง.

```bash
accelerate launch --num_processes 2 trainer-program.py ...
```

- ุงุณุชุฎุฏู --num_gpus ูุชุญุฏูุฏ ุนุฏุฏ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง.

```bash
deepspeed --num_gpus 2 trainer-program.py ...
```

### ุชุฑุชูุจ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU)

ุงูุขูุ ูุงุฎุชูุงุฑ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุชู ุชุฑูุฏ ุงุณุชุฎุฏุงููุง ูุชุฑุชูุจูุงุ ุณุชุณุชุฎุฏู ูุชุบูุฑ ุงูุจูุฆุฉ CUDA_VISIBLE_DEVICES. ูู ุงูุฃุณูู ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ ูู ููู ~bashrc ุฃู ููู ุชููุฆุฉ ุขุฎุฑ. ูุณุชุฎุฏู CUDA_VISIBLE_DEVICES ูุชุนููู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุชู ูุชู ุงุณุชุฎุฏุงููุง. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ูุฏูู 4 ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) (0ุ 1ุ 2ุ 3) ูุชุฑูุฏ ุชุดุบูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) 0 ู 2 ููุท:

```bash
CUDA_VISIBLE_DEVICES=0,2 torchrun trainer-program.py ...
```

ุชููู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงููุงุฏูุฉ 0 ู 2 ููุท "ูุฑุฆูุฉ" ูู PyTorchุ ููุชู ุชุนููููุง ุฅูู cuda:0 ู cuda:1 ุนูู ุงูุชูุงูู. ููููู ุฃูุถูุง ุนูุณ ุชุฑุชูุจ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ูุงุณุชุฎุฏุงู 2 ุฃููุงู. ุงูุขูุ ูุชู ุชุนููู ุงูุฎุฑูุทุฉ ุฅูู cuda:1 ูู GPU 0 ู cuda:0 ูู GPU 2.

```bash
CUDA_VISIBLE_DEVICES=2,0 torchrun trainer-program.py ...
```

ููููู ุฃูุถูุง ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ CUDA_VISIBLE_DEVICES ุฅูู ูููุฉ ูุงุฑุบุฉ ูุฅูุดุงุก ุจูุฆุฉ ุจุฏูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช (GPU).

```bash
CUDA_VISIBLE_DEVICES= python trainer-program.py ...
```

ูุตูุญุฉ: ููุง ูู ุงูุญุงู ูุน ุฃู ูุชุบูุฑ ุจูุฆูุ ูููู ุชุตุฏูุฑูุง ุจุฏูุงู ูู ุฅุถุงูุชูุง ุฅูู ุณุทุฑ ุงูุฃูุงูุฑ. ููุน ุฐููุ ูุง ููุตู ุจุฐูู ูุฃูู ูููู ุฃู ูููู ูุฑุจููุง ุฅุฐุง ูุณูุช ููููุฉ ุฅุนุฏุงุฏ ูุชุบูุฑ ุงูุจูุฆุฉ ููุฏ ููุชูู ุจู ุงูุฃูุฑ ุจุงุณุชุฎุฏุงู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุฎุทุฃ. ุจุฏูุงู ูู ุฐููุ ูู ุงูุดุงุฆุน ุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ ูุชุดุบูู ุชุฏุฑูุจ ูุญุฏุฏ ุนูู ููุณ ุณุทุฑ ุงูุฃูุงูุฑ.

CUDA_DEVICE_ORDER ูู ูุชุบูุฑ ุจูุฆู ุจุฏูู ููููู ุงุณุชุฎุฏุงูู ููุชุญูู ูู ููููุฉ ุชุฑุชูุจ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU). ููููู ุชุฑุชูุจูุง ุฅูุง ุนู ุทุฑูู:

1. ูุนุฑูุงุช ุญุงููุฉ PCIe ุงูุชู ุชุชุทุงุจู ูุน ุชุฑุชูุจ nvidia-smi ู rocm-smi ูู NVIDIA ู AMD GPUs ุนูู ุงูุชูุงูู

```bash
export CUDA_DEVICE_ORDER=PCI_BUS_ID
```

2. ูุฏุฑุฉ ุงูุญูุณุจุฉ GPU

```bash
export CUDA_DEVICE_ORDER=FASTEST_FIRST
```

CUDA_DEVICE_ORDER ูููุฏ ุจุดูู ุฎุงุต ุฅุฐุง ูุงูุช ุฅุนุฏุงุฏุงุช ุงูุชุฏุฑูุจ ุงูุฎุงุตุฉ ุจู ุชุชููู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ุฃูุฏู ูุฃุญุฏุซุ ุญูุซ ุชุธูุฑ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุฃูุฏู ุฃููุงูุ ูููู ูุง ููููู ุงูุชุจุฏูู ูุนูููุง ุจูู ุงูุจุทุงูุงุช ูุฌุนู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุฃุญุฏุซ ุชุธูุฑ ุฃููุงู. ูู ูุฐู ุงูุญุงูุฉุ ูู ุจุชุนููู CUDA_DEVICE_ORDER=FASTEST_FIRST ูุงุณุชุฎุฏุงู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุงูุฃุญุฏุซ ูุงูุฃุณุฑุน ุฃููุงู (ูุง ูุฒุงู nvidia-smi ุฃู rocm-smi ูุจูุบ ุนู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ููููุง ูุชุฑุชูุจ PCIe ุงูุฎุงุต ุจูุง). ุฃู ููููู ุฃูุถูุง ุชุนููู export CUDA_VISIBLE_DEVICES=1,0.